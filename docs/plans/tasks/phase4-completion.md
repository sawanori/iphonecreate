# Phase 4 完了検証

## メタ情報

| 項目 | 内容 |
|------|------|
| タスクID | phase4-completion |
| フェーズ | Phase 4: 管理画面 |
| 作成日 | 2026-01-14 |
| 想定工数 | 0.5日 |
| 検証レベル | L2（統合） |

---

## 概要

Phase 4 の全タスクが完了していることを確認し、管理画面が正常に動作することを検証する。フロー作成から動画アップロード、分岐設定、保存、プレビューまでの一連フローを確認する。

---

## 前提条件

### 依存タスク
- phase4-001-reactflow-editor.md
- phase4-002-custom-nodes.md
- phase4-003-r2-storage.md
- phase4-004-video-upload.md
- phase4-005-branch-api.md
- phase4-006-admin-page.md

---

## 完了タスクチェックリスト

### phase4-001: React Flow エディタ基盤
- [ ] React Flow がインストールされている
- [ ] ノードの追加・削除・移動が動作する
- [ ] ズーム・パン操作が動作する

### phase4-002: カスタムノード実装
- [ ] VideoNode, EndNode が作成されている
- [ ] AC-A-001: フローチャート上でノードをドラッグ&ドロップできる
- [ ] AC-A-002: ノード間を線で接続できる

### phase4-003: R2 ストレージ接続
- [ ] R2 バケットに接続できる
- [ ] 署名付きURL生成が動作する

### phase4-004: 動画アップロード機能
- [ ] AC-A-003: MP4ファイルをアップロードできる
- [ ] AC-UPLOAD-002: 500MBを超えるファイルは拒否される
- [ ] AC-UPLOAD-003: MP4以外の形式は拒否される

### phase4-005: 分岐設定API
- [ ] スキーマがマイグレーション済み
- [ ] AC-A-004: 各動画に選択肢テキストと制限時間を設定できる
- [ ] CRUD操作が動作する

### phase4-006: 管理画面ページ統合
- [ ] ダッシュボードが表示される
- [ ] エディターが動作する
- [ ] AC-A-005: プレビューで動画フローを確認できる

---

## E2E検証手順

### 1. 管理画面アクセス

```bash
npm run dev
# admin@example.com / password123 でログイン
# http://localhost:3000/dashboard にアクセス
```

### 2. プロジェクト作成フロー

```
1. ダッシュボード > 「新規プロジェクト作成」
2. プロジェクトタイトルを入力
3. 「保存」をクリック
4. エディターページにリダイレクトされる
```

### 3. フローチャート編集

```
1. ツールバーから「動画ノード」をドラッグ&ドロップ
2. さらに「動画ノード」と「終了ノード」を追加
3. ノード間を接続（ソースからターゲットへドラッグ）
4. ノードを選択してサイドパネルで設定
```

### 4. 動画アップロード

```
1. ノードを選択
2. 「動画をアップロード」をクリック
3. MP4ファイルを選択
4. アップロード進捗を確認
5. 完了後、サムネイルが表示される
```

### 5. 保存とプレビュー

```
1. 「保存」をクリック
2. 「プレビュー」をクリック
3. 視聴画面が新しいタブで開く
4. 動画再生と分岐が動作することを確認
```

---

## 受入条件達成状況

### 管理画面

- [ ] AC-A-001: フローチャート上でノードをドラッグ&ドロップできる
- [ ] AC-A-002: ノード間を線で接続できる
- [ ] AC-A-003: MP4ファイルをアップロードできる
- [ ] AC-A-004: 各動画に選択肢テキストと制限時間を設定できる
- [ ] AC-A-005: プレビューで動画フローを確認できる

### ファイルアップロード

- [ ] AC-UPLOAD-001: MP4ファイル用の署名付きURLが発行される
- [ ] AC-UPLOAD-002: 500MBを超えるファイルは拒否される
- [ ] AC-UPLOAD-003: MP4以外の形式は拒否される
- [ ] AC-UPLOAD-004: アップロード完了後にメタデータが取得できる

---

## 成果物確認

### 必須ファイル一覧

```
src/
├── app/
│   ├── (admin)/
│   │   ├── layout.tsx
│   │   ├── dashboard/
│   │   │   └── page.tsx
│   │   └── editor/
│   │       └── [projectId]/
│   │           └── page.tsx
│   └── api/
│       ├── upload/
│       │   ├── route.ts
│       │   └── complete/
│       │       └── route.ts
│       └── videos/
│           ├── route.ts
│           └── [videoId]/
│               ├── route.ts
│               └── branches/
│                   └── route.ts
├── components/
│   ├── editor/
│   │   ├── index.ts
│   │   ├── FlowEditor.tsx
│   │   ├── VideoNode.tsx
│   │   ├── EndNode.tsx
│   │   ├── ChoiceNode.tsx
│   │   └── NodeToolbar.tsx
│   ├── layout/
│   │   └── AdminLayout.tsx
│   └── upload/
│       ├── index.ts
│       ├── VideoUploader.tsx
│       └── UploadProgress.tsx
├── hooks/
│   └── useFlowEditor.ts
├── lib/
│   ├── db/
│   │   └── schema/
│   │       └── videos.ts
│   ├── services/
│   │   ├── video.service.ts
│   │   └── branch.service.ts
│   └── storage/
│       ├── index.ts
│       ├── r2.ts
│       └── signed-url.ts
└── stores/
    └── editorStore.ts
```

---

## Phase 4 完了条件

- [ ] 全タスクのチェックリストが完了している
- [ ] フロー作成→動画アップロード→分岐設定→保存→プレビューの動作確認完了
- [ ] 視聴画面との統合動作確認完了
- [ ] 権限管理動作確認完了
- [ ] 全受入条件を達成している

---

## 次のフェーズへの引き継ぎ事項

### Phase 5 で使用する成果物
- 動画プロジェクトスキーマ: 進捗記録で使用
- API ルート: 進捗記録APIの参考
- editorStore: 進捗管理ストアの参考

### 注意事項
- プロジェクト公開状態（isPublished）で視聴可否を制御
- 進捗は視聴画面から記録、管理画面で分析

---

## 問題発生時の対処

### R2 接続エラーの場合
1. 環境変数を確認
2. R2 バケットのCORS設定を確認
3. アクセスキーの権限を確認

### フローエディタが動作しない場合
1. React Flow のインポートを確認
2. nodeTypes の登録を確認
3. コンソールエラーを確認

### アップロードが失敗する場合
1. ファイルサイズを確認（500MB以下）
2. ファイル形式を確認（MP4のみ）
3. ネットワーク接続を確認

---

## 承認

- [ ] Phase 4 完了を確認
- [ ] Phase 5 開始準備完了
